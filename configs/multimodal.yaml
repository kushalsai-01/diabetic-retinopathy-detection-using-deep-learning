# Multimodal Configuration for DR Classification
# Combines fundus images + patient clinical data

dataset:
  name: "multimodal_dr"
  root_dir: "data/processed"
  image_col: "image_path"
  label_col: "diagnosis"
  
  # CSV files
  train_csv: "train.csv"
  val_csv: "val.csv"
  test_csv: "test.csv"
  
  # Tabular/Clinical features
  tabular_features:
    enabled: true
    features:
      - age                    # Patient age (years)
      - gender                 # 0=Female, 1=Male
      - diabetes_duration      # Years since diabetes diagnosis
      - hba1c                  # Glycated hemoglobin (%)
      - bp_sys                 # Systolic blood pressure (mmHg)
      - bp_dia                 # Diastolic blood pressure (mmHg)
      - bmi                    # Body Mass Index
      - smoking                # 0=Never, 1=Former, 2=Current
      - insulin                # 0=No, 1=Yes
    
    # Normalization (mean and std for each feature)
    # Auto-computed from training data if not provided
    normalize: true
    normalization:
      age:
        mean: 55.0
        std: 12.0
      gender:
        mean: 0.5
        std: 0.5
      diabetes_duration:
        mean: 10.0
        std: 6.0
      hba1c:
        mean: 7.5
        std: 1.5
      bp_sys:
        mean: 135.0
        std: 18.0
      bp_dia:
        mean: 85.0
        std: 12.0
      bmi:
        mean: 28.0
        std: 5.0
      smoking:
        mean: 0.5
        std: 0.7
      insulin:
        mean: 0.4
        std: 0.5

preprocessing:
  image_size: 512
  crop_size: 448
  normalize:
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]

augmentation:
  train:
    # Conservative augmentations for medical images
    horizontal_flip: true
    vertical_flip: true
    rotation_limit: 15          # ±15° (medically appropriate)
    brightness_limit: 0.15       # ±15% brightness
    contrast_limit: 0.15         # ±15% contrast
    hue_saturation_limit: 0.08   # Mild color variation
    blur_limit: 3
    clahe_clip_limit: 2.0        # CLAHE for retinal features
    
    # Crop with scale for zoom variation
    random_crop_scale: [0.9, 1.0]
    
    coarse_dropout:
      enabled: true
      max_holes: 8
      max_height: 32
      max_width: 32
      
  val:
    resize_only: true

# Model configuration
model:
  type: "multimodal"
  num_classes: 5
  
  # Image backbone
  backbone: "resnet50"          # Options: resnet50, efficientnet_b3, vit_base_patch16_224
  pretrained: true
  freeze_backbone: false
  
  # Tabular encoder
  num_tabular_features: 9
  tabular_hidden_dims: [128, 64]
  
  # Fusion strategy
  fusion_type: "concat"         # Options: concat, addition, attention
  
  # Regularization
  dropout_rate: 0.3
  tabular_dropout_rate: 0.5     # CRITICAL: Randomly drops tabular during training
                                 # This makes model work without clinical data
  
# Training configuration
training:
  batch_size: 16                # Reduced for multimodal
  num_epochs: 50
  learning_rate: 0.0001
  weight_decay: 0.0001
  
  # Optimizer
  optimizer: "adamw"
  scheduler: "cosine"
  warmup_epochs: 3
  
  # Loss function
  loss: "focal"                 # Options: cross_entropy, focal, label_smoothing
  focal_alpha: [1.0, 1.5, 2.0, 2.5, 3.0]  # Class weights
  focal_gamma: 2.0
  
  # Early stopping
  patience: 10
  monitor: "val_kappa"
  mode: "max"

# Class weighting
class_weights:
  enabled: true
  method: "inverse_frequency"

# Inference
inference:
  # Model can work in two modes:
  # 1. multimodal: Use both image + clinical data
  # 2. image_only: Use only image (set tabular to None or zeros)
  default_mode: "multimodal"
  
  # Test-time augmentation
  tta:
    enabled: false
    n_augmentations: 5

# Hardware
hardware:
  num_workers: 4
  pin_memory: true
  mixed_precision: true
  
# Logging
logging:
  wandb:
    enabled: false
    project: "multimodal-dr"
  tensorboard:
    enabled: true
    log_dir: "experiments/logs"
  
  # Log frequency
  log_every_n_steps: 50
  
# Checkpointing
checkpointing:
  save_dir: "experiments/checkpoints"
  save_top_k: 3
  monitor: "val_kappa"
  mode: "max"
  filename: "multimodal-dr-{epoch:02d}-{val_kappa:.3f}"
